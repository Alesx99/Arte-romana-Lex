<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramma Interattivo - Arte Romana</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #20c997);
            color: white;
        }

        .canvas-container {
            position: relative;
            height: 600px;
            background: #fafafa;
            overflow: hidden;
            cursor: crosshair;
        }

        #canvas {
            border: 2px solid #e9ecef;
            background: white;
        }

        .node {
            position: absolute;
            min-width: 120px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }



        .node-text {
            flex: 1;
        }

        .info-icon-external {
            position: absolute;
            background: #667eea;
            border: 2px solid #333;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: #fff;
            z-index: 1001;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            pointer-events: auto;
            user-select: none;
        }

        .info-icon-external:hover {
            background: #5a6fd8;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .node:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .node.selected {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow: 0 0 20px rgba(240, 147, 251, 0.6);
        }

        .node.architecture {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .node.sculpture {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
        }

        .node.painting {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .node.period {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        .node.technique {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .arrow {
            position: absolute;
            pointer-events: none;
            z-index: 1;
        }

        .arrow svg {
            width: 100%;
            height: 100%;
        }

        .arrow path {
            stroke: #2c3e50;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
            opacity: 0.7;
        }

        .arrow text {
            font-size: 10px;
            fill: #2c3e50;
            font-weight: 600;
            opacity: 0.8;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .legend {
            background: white;
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }

        .legend h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .legend-items {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .info-popup {
            display: none;
            position: fixed;
            z-index: 3000;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 20px;
            max-width: 500px;
            min-width: 300px;
            border: 2px solid #667eea;
            max-height: 80vh;
            overflow-y: auto;
        }

        .info-popup h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .info-popup p {
            color: #34495e;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .info-popup .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .info-popup .close-btn:hover {
            background: #ee5a24;
            transform: scale(1.1);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn {
                width: 100%;
            }
            
            .legend-items {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Diagramma Interattivo - Arte Romana</h1>
            <p>Esplora i concetti dell'Arte Romana attraverso un diagramma di flusso interattivo e modificabile</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="addNode()">‚ûï Aggiungi Nodo</button>
            <button class="btn btn-success" onclick="addArrow()">‚û°Ô∏è Aggiungi Freccia</button>
            <button class="btn btn-warning" onclick="editSelected()">‚úèÔ∏è Modifica Selezionato</button>
            <button class="btn btn-danger" onclick="deleteSelected()">üóëÔ∏è Elimina Selezionato</button>
            <button class="btn btn-primary" onclick="editDescriptions()">üìù Modifica Descrizioni</button>
            <button class="btn btn-success" onclick="exportDescriptions()">üì§ Esporta Descrizioni</button>
            <button class="btn btn-warning" onclick="importDescriptions()">üì• Importa Descrizioni</button>
            <button class="btn btn-primary" onclick="saveDiagram()">üíæ Salva Diagramma</button>
            <button class="btn btn-success" onclick="loadDiagram()">üìÇ Carica Diagramma</button>
            <button class="btn btn-warning" onclick="resetDiagram()">üîÑ Reset</button>
            <button class="btn btn-info" onclick="toggleArrows()" id="toggleArrowsBtn">üëÅÔ∏è Mostra Frecce</button>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="canvas" width="1200" height="600"></canvas>
            <div class="tooltip" id="tooltip"></div>
        </div>

        <!-- Popup informativo -->
        <div id="infoPopup" class="info-popup">
            <button class="close-btn" onclick="closeInfoPopup()">√ó</button>
            <h3 id="popupTitle"></h3>
            <div id="popupContent"></div>
        </div>

        <div class="legend">
            <h3>üé® Legenda</h3>
            <div class="legend-items">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                    <span>Architettura</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #56ab2f, #a8e6cf);"></div>
                    <span>Scultura</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #f093fb, #f5576c);"></div>
                    <span>Pittura</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);"></div>
                    <span>Periodo Storico</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></div>
                    <span>Tecnica</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per aggiungere/modificare nodi -->
    <div id="nodeModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Aggiungi Nodo</h2>
            <div class="form-group">
                <label for="nodeText">Testo del Nodo:</label>
                <input type="text" id="nodeText" placeholder="Inserisci il testo del nodo">
            </div>
            <div class="form-group">
                <label for="nodeType">Tipo:</label>
                <select id="nodeType">
                    <option value="architecture">Architettura</option>
                    <option value="sculpture">Scultura</option>
                    <option value="painting">Pittura</option>
                    <option value="period">Periodo Storico</option>
                    <option value="technique">Tecnica</option>
                </select>
            </div>
            <div class="form-group">
                <label for="nodeX">Posizione X:</label>
                <input type="number" id="nodeX" min="0" max="1200">
            </div>
            <div class="form-group">
                <label for="nodeY">Posizione Y:</label>
                <input type="number" id="nodeY" min="0" max="600">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeModal()">‚ùå Annulla</button>
                <button class="btn btn-success" onclick="saveNode()">‚úÖ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal per aggiungere frecce -->
    <div id="arrowModal" class="modal">
        <div class="modal-content">
            <h2>Aggiungi Freccia</h2>
            <div class="form-group">
                <label for="arrowFrom">Da Nodo:</label>
                <select id="arrowFrom">
                    <!-- Popolato dinamicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="arrowTo">A Nodo:</label>
                <select id="arrowTo">
                    <!-- Popolato dinamicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="arrowLabel">Etichetta (opzionale):</label>
                <input type="text" id="arrowLabel" placeholder="Inserisci etichetta">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeModal()">‚ùå Annulla</button>
                <button class="btn btn-success" onclick="saveArrow()">‚úÖ Salva</button>
            </div>
        </div>
    </div>

    <!-- Modal per modificare descrizioni -->
    <div id="descriptionModal" class="modal">
        <div class="modal-content">
            <h2>Modifica Descrizioni</h2>
            <div class="form-group">
                <label for="descriptionNodeSelect">Seleziona Nodo:</label>
                <select id="descriptionNodeSelect">
                    <!-- Popolato dinamicamente -->
                </select>
            </div>
            <div class="form-group">
                <label for="descriptionTitle">Titolo:</label>
                <input type="text" id="descriptionTitle" placeholder="Inserisci il titolo">
            </div>
            <div class="form-group">
                <label for="descriptionText">Descrizione Principale:</label>
                <textarea id="descriptionText" rows="4" placeholder="Inserisci la descrizione principale"></textarea>
            </div>
            <div class="form-group">
                <label for="descriptionPeriod">Periodo (opzionale):</label>
                <input type="text" id="descriptionPeriod" placeholder="es. 753 a.C. - 476 d.C.">
            </div>
            <div class="form-group">
                <label for="descriptionFeatures">Caratteristiche (opzionale):</label>
                <input type="text" id="descriptionFeatures" placeholder="es. Archi, Volte, Cupole">
            </div>
            <div class="form-group">
                <label for="descriptionFunction">Funzione (opzionale):</label>
                <input type="text" id="descriptionFunction" placeholder="es. Centro politico e religioso">
            </div>
            <div class="form-group">
                <label for="descriptionPurpose">Scopo (opzionale):</label>
                <input type="text" id="descriptionPurpose" placeholder="es. Propaganda politica">
            </div>
            <div class="form-group">
                <label for="descriptionType">Tipo (opzionale):</label>
                <input type="text" id="descriptionType" placeholder="es. Ritratti scultorei">
            </div>
            <div class="form-group">
                <label for="descriptionTechnique">Tecnica (opzionale):</label>
                <input type="text" id="descriptionTechnique" placeholder="es. Pittura su intonaco fresco">
            </div>
            <div class="form-group">
                <label for="descriptionMedium">Supporto (opzionale):</label>
                <input type="text" id="descriptionMedium" placeholder="es. Tavola, Tela, Legno">
            </div>
            <div class="form-group">
                <label for="descriptionLocation">Ubicazione (opzionale):</label>
                <input type="text" id="descriptionLocation" placeholder="es. Pavimenti, Pareti">
            </div>
            <div class="form-group">
                <label for="descriptionMaterial">Materiale (opzionale):</label>
                <input type="text" id="descriptionMaterial" placeholder="es. Marmo, Travertino">
            </div>
            <div class="form-group">
                <label for="descriptionExample">Esempio (opzionale):</label>
                <input type="text" id="descriptionExample" placeholder="es. Villa del Casale">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="closeModal()">‚ùå Annulla</button>
                <button class="btn btn-success" onclick="saveDescription()">‚úÖ Salva Descrizione</button>
            </div>
        </div>
    </div>

    <script>
        // Dati iniziali dell'Arte Romana con informazioni dettagliate
        const nodeInfo = {
            1: {
                title: "Arte Romana",
                description: "L'arte romana si svilupp√≤ dal 753 a.C. al 476 d.C., caratterizzata da realismo, funzionalit√† e grandiosit√†. Influenzata dall'arte greca ed etrusca, si distinse per l'uso di materiali come marmo, travertino e laterizio.",
                period: "753 a.C. - 476 d.C."
            },
            2: {
                title: "Architettura",
                description: "L'architettura romana rappresenta uno dei massimi esempi di ingegneria antica. Caratterizzata da archi, volte e cupole, utilizzava tecniche innovative come il calcestruzzo romano.",
                features: "Archi, Volte, Cupole, Calcestruzzo"
            },
            3: {
                title: "Scultura",
                description: "La scultura romana si caratterizz√≤ per il realismo e la ritrattistica. I busti imperiali e le statue celebrative erano strumenti di propaganda politica.",
                features: "Realismo, Ritrattistica, Propaganda"
            },
            4: {
                title: "Pittura",
                description: "La pittura romana includeva affreschi murali, ritratti su tavola e decorazioni parietali. Gli stili pompeiani mostrano la variet√† delle tecniche pittoriche.",
                features: "Affreschi, Ritratti, Decorazioni"
            },
            5: {
                title: "Mosaico",
                description: "Il mosaico romano utilizzava tessere di marmo, vetro e pietra per creare decorazioni pavimentali e parietali. I mosaici di Villa del Casale a Piazza Armerina sono esempi eccezionali.",
                features: "Tessere, Pavimenti, Decorazioni"
            },
            6: {
                title: "Colosseo",
                description: "Anfiteatro Flavio (70-80 d.C.), simbolo dell'architettura romana. Poteva ospitare 50.000 spettatori per spettacoli gladiatori e naumachie.",
                period: "70-80 d.C.",
                capacity: "50.000 spettatori"
            },
            7: {
                title: "Pantheon",
                description: "Tempio dedicato a tutti gli dei, ricostruito da Adriano (118-128 d.C.). La cupola in calcestruzzo √® un capolavoro di ingegneria antica.",
                period: "118-128 d.C.",
                feature: "Cupola in calcestruzzo"
            },
            8: {
                title: "Foro Romano",
                description: "Centro politico, religioso e commerciale di Roma antica. Conteneva templi, basiliche e monumenti celebrativi come la Colonna di Traiano.",
                function: "Centro politico e religioso"
            },
            9: {
                title: "Statue Imperiali",
                description: "Ritratti ufficiali degli imperatori romani, utilizzati per la propaganda politica. Esempi famosi: Augusto di Prima Porta, Marco Aurelio a cavallo.",
                purpose: "Propaganda politica"
            },
            10: {
                title: "Busti",
                description: "Ritratti scultorei della testa e delle spalle, molto diffusi nell'arte romana. Rappresentavano personaggi illustri e membri delle famiglie aristocratiche.",
                type: "Ritratti scultorei"
            },
            11: {
                title: "Affreschi",
                description: "Pitture murali realizzate su intonaco fresco. Gli affreschi di Pompei mostrano scene mitologiche, paesaggi e vita quotidiana.",
                technique: "Pittura su intonaco fresco"
            },
            12: {
                title: "Ritratti",
                description: "Dipinti su tavola o tela che rappresentavano personaggi. I ritratti del Fayyum in Egitto sono esempi eccezionali di pittura su tavola.",
                medium: "Tavola, Tela, Legno"
            },
            13: {
                title: "Mosaici Pavimentali",
                description: "Decorazioni pavimentali realizzate con tessere colorate. I mosaici di Villa del Casale mostrano scene di caccia e vita quotidiana.",
                location: "Pavimenti, Pareti"
            },
            14: {
                title: "Arco di Costantino",
                description: "Arco trionfale eretto nel 315 d.C. per celebrare la vittoria di Costantino su Massenzio. Decorato con rilievi provenienti da monumenti precedenti.",
                period: "315 d.C.",
                purpose: "Celebrazione vittoria"
            },
            15: {
                title: "Basilica",
                description: "Edificio pubblico per assemblee e tribunali. La basilica di Massenzio √® uno degli esempi pi√π grandiosi di architettura romana.",
                function: "Assemblee e tribunali"
            },
            16: {
                title: "Tempio",
                description: "Luogo di culto dedicato agli dei. I templi romani seguivano gli ordini architettonici greci con modifiche proprie.",
                purpose: "Culto religioso"
            },
            17: {
                title: "Terme",
                description: "Complessi termali pubblici per bagni e attivit√† sociali. Le Terme di Caracalla sono uno degli esempi pi√π grandiosi.",
                function: "Bagni pubblici e socialit√†"
            },
            18: {
                title: "Villa",
                description: "Residenza di campagna delle famiglie aristocratiche. Villa Adriana a Tivoli √® un esempio eccezionale di villa imperiale.",
                type: "Residenza aristocratica"
            },
            19: {
                title: "Impero Romano",
                description: "Periodo dal 27 a.C. al 476 d.C. caratterizzato da stabilit√† politica e grandi opere architettoniche. L'arte raggiunse il massimo splendore.",
                period: "27 a.C. - 476 d.C."
            },
            20: {
                title: "Repubblica",
                description: "Periodo dal 509 a.C. al 27 a.C. in cui Roma si espanse e svilupp√≤ le prime forme di arte pubblica e commemorativa.",
                period: "509 a.C. - 27 a.C."
            },
            21: {
                title: "Arco",
                description: "Elemento architettonico che permette di coprire aperture utilizzando la spinta laterale. Gli archi romani erano costruiti in pietra o calcestruzzo.",
                material: "Pietra, Calcestruzzo"
            },
            22: {
                title: "Volta",
                description: "Struttura curva che copre uno spazio utilizzando la spinta laterale. Le volte a botte e a crociera sono tipiche dell'architettura romana.",
                types: "Volta a botte, Volta a crociera"
            },
            23: {
                title: "Cupola",
                description: "Struttura emisferica che copre uno spazio circolare. La cupola del Pantheon √® un capolavoro di ingegneria antica.",
                example: "Cupola del Pantheon"
            },
            24: {
                title: "Ordini Architettonici",
                description: "Sistemi di proporzioni e decorazioni architettoniche. I Romani utilizzarono gli ordini dorico, ionico e corinzio, aggiungendo l'ordine composito.",
                orders: "Dorico, Ionico, Corinzio, Composito"
            }
        };

        const initialData = {
            nodes: [
                { id: 1, text: "Arte Romana", type: "period", x: 600, y: 50 },
                { id: 2, text: "Architettura", type: "architecture", x: 200, y: 150 },
                { id: 3, text: "Scultura", type: "sculpture", x: 400, y: 150 },
                { id: 4, text: "Pittura", type: "painting", x: 600, y: 150 },
                { id: 5, text: "Mosaico", type: "technique", x: 800, y: 150 },
                { id: 6, text: "Colosseo", type: "architecture", x: 100, y: 250 },
                { id: 7, text: "Pantheon", type: "architecture", x: 300, y: 250 },
                { id: 8, text: "Foro Romano", type: "architecture", x: 500, y: 250 },
                { id: 9, text: "Statue Imperiali", type: "sculpture", x: 700, y: 250 },
                { id: 10, text: "Busti", type: "sculpture", x: 900, y: 250 },
                { id: 11, text: "Affreschi", type: "painting", x: 200, y: 350 },
                { id: 12, text: "Ritratti", type: "painting", x: 400, y: 350 },
                { id: 13, text: "Mosaici Pavimentali", type: "technique", x: 600, y: 350 },
                { id: 14, text: "Arco di Costantino", type: "architecture", x: 800, y: 350 },
                { id: 15, text: "Basilica", type: "architecture", x: 100, y: 450 },
                { id: 16, text: "Tempio", type: "architecture", x: 300, y: 450 },
                { id: 17, text: "Terme", type: "architecture", x: 500, y: 450 },
                { id: 18, text: "Villa", type: "architecture", x: 700, y: 450 },
                { id: 19, text: "Impero Romano", type: "period", x: 900, y: 450 },
                { id: 20, text: "Repubblica", type: "period", x: 100, y: 550 },
                { id: 21, text: "Arco", type: "technique", x: 300, y: 550 },
                { id: 22, text: "Volta", type: "technique", x: 500, y: 550 },
                { id: 23, text: "Cupola", type: "technique", x: 700, y: 550 },
                { id: 24, text: "Ordini Architettonici", type: "technique", x: 900, y: 550 }
            ],
            arrows: [
                { from: 1, to: 2, label: "include" },
                { from: 1, to: 3, label: "include" },
                { from: 1, to: 4, label: "include" },
                { from: 1, to: 5, label: "include" },
                { from: 2, to: 6, label: "esempi" },
                { from: 2, to: 7, label: "esempi" },
                { from: 2, to: 8, label: "esempi" },
                { from: 2, to: 14, label: "esempi" },
                { from: 2, to: 15, label: "esempi" },
                { from: 2, to: 16, label: "esempi" },
                { from: 2, to: 17, label: "esempi" },
                { from: 2, to: 18, label: "esempi" },
                { from: 3, to: 9, label: "esempi" },
                { from: 3, to: 10, label: "esempi" },
                { from: 4, to: 11, label: "esempi" },
                { from: 4, to: 12, label: "esempi" },
                { from: 5, to: 13, label: "esempi" },
                { from: 6, to: 21, label: "usa" },
                { from: 7, to: 23, label: "usa" },
                { from: 8, to: 22, label: "usa" },
                { from: 14, to: 21, label: "usa" },
                { from: 15, to: 22, label: "usa" },
                { from: 16, to: 24, label: "usa" },
                { from: 17, to: 22, label: "usa" },
                { from: 18, to: 22, label: "usa" },
                { from: 19, to: 1, label: "periodo" },
                { from: 20, to: 1, label: "periodo" }
            ]
        };

        let nodes = [...initialData.nodes];
        let arrows = [...initialData.arrows];
        let selectedNode = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let startX = 0, startY = 0;
        let nextNodeId = Math.max(...nodes.map(n => n.id)) + 1;
        let arrowsVisible = true;

        // Inizializza il testo del pulsante
        document.addEventListener('DOMContentLoaded', function() {
            const btn = document.getElementById('toggleArrowsBtn');
            if (btn) {
                btn.textContent = 'üëÅÔ∏è Nascondi Frecce';
            }
        });

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');

        // Inizializzazione
        function init() {
            render();
            setupEventListeners();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Aggiungi event listener per il click sul canvas per deselezionare
            canvas.addEventListener('click', function(e) {
                // Se clicchi sul canvas (non su un nodo), deseleziona
                if (e.target === canvas) {
                    selectedNode = null;
                    updateNodeSelection();
                    render();
                }
            });
            
            // Aggiungi event listener globali per il drag
            document.addEventListener('mousemove', handleGlobalMouseMove);
            document.addEventListener('mouseup', handleGlobalMouseUp);
        }

        // Gestione eventi mouse
        function handleMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const node = getNodeAtPosition(x, y);
            if (node) {
                selectedNode = node;
                isDragging = true;
                dragOffset.x = x - node.x;
                dragOffset.y = y - node.y;
                updateNodeSelection();
                render();
            }
        }

        function handleMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (isDragging && selectedNode) {
                selectedNode.x = x - dragOffset.x;
                selectedNode.y = y - dragOffset.y;
                render();
            }

            // Tooltip
            const node = getNodeAtPosition(x, y);
            if (node) {
                tooltip.style.display = 'block';
                tooltip.style.left = e.clientX + 10 + 'px';
                tooltip.style.top = e.clientY + 10 + 'px';
                tooltip.textContent = `Tipo: ${node.type} | ID: ${node.id}`;
            } else {
                tooltip.style.display = 'none';
            }
        }

        function handleMouseUp() {
            isDragging = false;
        }

        function handleGlobalMouseMove(e) {
            if (selectedNode && isDragging) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                selectedNode.x = x - dragOffset.x;
                selectedNode.y = y - dragOffset.y;
                render();
            }
        }

        function handleGlobalMouseUp() {
            isDragging = false;
            // Reset delle variabili di drag
            selectedNode = null;
            updateNodeSelection();
            render();
        }

        function handleClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const node = getNodeAtPosition(x, y);
            if (node) {
                showInfoPopup(node);
            } else {
                selectedNode = null;
                updateNodeSelection();
                render();
            }
        }

        function handleDoubleClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const node = getNodeAtPosition(x, y);
            if (node) {
                selectedNode = node;
                updateNodeSelection();
                render();
                editNode(node);
            }
        }

        // Funzioni di utilit√†
        function getNodeAtPosition(x, y) {
            return nodes.find(node => 
                x >= node.x && x <= node.x + 120 && 
                y >= node.y && y <= node.y + 60
            );
        }

        function updateNodeSelection() {
            nodes.forEach(node => {
                const element = document.querySelector(`[data-node-id="${node.id}"]`);
                if (element) {
                    element.classList.toggle('selected', node === selectedNode);
                }
            });
        }

        // Rendering
        function render() {
            // Pulisci canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Rimuovi tutte le frecce esistenti
            const existingArrows = document.querySelectorAll('.arrow');
            existingArrows.forEach(arrow => arrow.remove());

            // Rimuovi tutte le icone info esterne esistenti
            const existingInfoIcons = document.querySelectorAll('.info-icon-external');
            existingInfoIcons.forEach(icon => icon.remove());

            // Disegna frecce solo se visibili
            if (arrowsVisible) {
                arrows.forEach(arrow => {
                    drawArrow(arrow);
                });
            }

            // Rimuovi tutti i nodi esistenti
            const existingNodes = document.querySelectorAll('.node');
            existingNodes.forEach(node => node.remove());

            // Disegna nodi
            nodes.forEach(node => {
                drawNode(node);
            });
        }

                 function drawNode(node) {
             const element = document.createElement('div');
             element.className = `node ${node.type}`;
             element.style.left = node.x + 'px';
             element.style.top = node.y + 'px';
             element.setAttribute('data-node-id', node.id);

             if (node === selectedNode) {
                 element.classList.add('selected');
             }

             // Contenuto semplice del nodo senza icona info interna
             element.innerHTML = `<div class="node-text">${node.text}</div>`;

             // Aggiungi event listener per il drag sul nodo principale
             element.addEventListener('mousedown', function(e) {
                 e.stopPropagation(); // Previeni la propagazione al canvas
                 console.log('Mouse down su nodo:', node.id, node.text);
                 selectedNode = node;
                 isDragging = true;
                 startX = e.clientX;
                 startY = e.clientY;
                 const rect = canvas.getBoundingClientRect();
                 dragOffset.x = e.clientX - rect.left - node.x;
                 dragOffset.y = e.clientY - rect.top - node.y;
                 updateNodeSelection();
                 render();
             });

             // Aggiungi event listener per il doppio click sul nodo
             element.addEventListener('dblclick', function(e) {
                 e.stopPropagation(); // Previeni la propagazione al canvas
                 console.log('Doppio click su nodo:', node.id, node.text);
                 selectedNode = node;
                 updateNodeSelection();
                 render();
                 editNode(node);
             });

             document.getElementById('canvasContainer').appendChild(element);
             
             // Crea icona info esterna al box del nodo
             const infoIcon = document.createElement('div');
                         infoIcon.className = 'info-icon-external';
            infoIcon.innerHTML = '‚ÑπÔ∏è';
            infoIcon.title = 'Informazioni';
            infoIcon.tabIndex = 0; // Rende l'elemento focusable
             infoIcon.style.position = 'absolute';
             // Posiziona l'icona a destra del nodo (120px di larghezza minima + 8px di spazio)
             infoIcon.style.left = (node.x + 120 + 8) + 'px';
             // Posiziona l'icona al centro verticale del nodo (60px di altezza stimata)
             infoIcon.style.top = (node.y + 30 - 12) + 'px';
             infoIcon.style.width = '24px';
             infoIcon.style.height = '24px';
             infoIcon.style.backgroundColor = '#667eea';
             infoIcon.style.border = '2px solid #333';
             infoIcon.style.borderRadius = '50%';
             infoIcon.style.display = 'flex';
             infoIcon.style.alignItems = 'center';
             infoIcon.style.justifyContent = 'center';
             infoIcon.style.cursor = 'pointer';
             infoIcon.style.fontSize = '14px';
             infoIcon.style.color = '#fff';
             infoIcon.style.zIndex = '1001';
             infoIcon.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
             infoIcon.style.transition = 'all 0.2s ease';
             
             // Hover effect
             infoIcon.addEventListener('mouseenter', () => {
                 infoIcon.style.transform = 'scale(1.1)';
                 infoIcon.style.backgroundColor = '#5a6fd8';
                 infoIcon.style.boxShadow = '0 4px 8px rgba(0,0,0,0.4)';
             });
             
             infoIcon.addEventListener('mouseleave', () => {
                 infoIcon.style.transform = 'scale(1)';
                 infoIcon.style.backgroundColor = '#667eea';
                 infoIcon.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
             });
             
                         // Click event per il popup
            infoIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('Click su icona info per nodo:', node.id);
                console.log('Evento click registrato per nodo ID:', node.id);
                showInfoPopupById(node.id);
            });
            
            // Mouseup event per assicurarsi che il click venga registrato
            infoIcon.addEventListener('mouseup', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('Mouse up su icona info per nodo:', node.id);
                showInfoPopupById(node.id);
            });
            
            // Aggiungi anche un event listener per mousedown per debug
            infoIcon.addEventListener('mousedown', (e) => {
                console.log('Mouse down su icona info per nodo:', node.id);
                e.stopPropagation();
                e.preventDefault();
            });
            
            // Touch event per dispositivi mobili
            infoIcon.addEventListener('touchstart', (e) => {
                e.stopPropagation();
                e.preventDefault();
                console.log('Touch start su icona info per nodo:', node.id);
                showInfoPopupById(node.id);
            });
            
            // Keyboard event per accessibilit√†
            infoIcon.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.stopPropagation();
                    e.preventDefault();
                    console.log('Keydown su icona info per nodo:', node.id);
                    showInfoPopupById(node.id);
                }
            });
            
            // Focus event per debug
            infoIcon.addEventListener('focus', (e) => {
                console.log('Focus su icona info per nodo:', node.id);
            });
             
             document.getElementById('canvasContainer').appendChild(infoIcon);
         }

        function drawArrow(arrow) {
            const fromNode = nodes.find(n => n.id === arrow.from);
            const toNode = nodes.find(n => n.id === arrow.to);

            if (!fromNode || !toNode) return;

            const fromX = fromNode.x + 60;
            const fromY = fromNode.y + 30;
            const toX = toNode.x + 60;
            const toY = toNode.y + 30;

            // Calcola punti di controllo per curva
            const dx = toX - fromX;
            const dy = toY - fromY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const offset = Math.min(distance * 0.2, 30);

            const controlX = fromX + dx * 0.5;
            const controlY = fromY + dy * 0.5 + offset;

            // Crea elemento SVG per la freccia
            const arrowElement = document.createElement('div');
            arrowElement.className = 'arrow';
            arrowElement.style.left = '0px';
            arrowElement.style.top = '0px';
            arrowElement.style.width = canvas.width + 'px';
            arrowElement.style.height = canvas.height + 'px';

            const svg = `
                <svg width="${canvas.width}" height="${canvas.height}">
                    <defs>
                        <marker id="arrowhead" markerWidth="8" markerHeight="6" 
                                refX="7" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="#2c3e50"/>
                        </marker>
                    </defs>
                    <path d="M ${fromX} ${fromY} Q ${controlX} ${controlY} ${toX} ${toY}" 
                          stroke="#2c3e50" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
                    ${arrow.label ? `<text x="${controlX}" y="${controlY - 8}" text-anchor="middle" 
                        font-size="10" fill="#2c3e50" font-weight="600">${arrow.label}</text>` : ''}
                </svg>
            `;

            arrowElement.innerHTML = svg;
            document.getElementById('canvasContainer').appendChild(arrowElement);
        }

        // Funzioni per i controlli
        function addNode() {
            document.getElementById('modalTitle').textContent = 'Aggiungi Nodo';
            document.getElementById('nodeText').value = '';
            document.getElementById('nodeType').value = 'architecture';
            document.getElementById('nodeX').value = '100';
            document.getElementById('nodeY').value = '100';
            document.getElementById('nodeModal').style.display = 'block';
        }

        function editSelected() {
            if (!selectedNode) {
                alert('Seleziona prima un nodo da modificare');
                return;
            }
            editNode(selectedNode);
        }

        function editNode(node) {
            document.getElementById('modalTitle').textContent = 'Modifica Nodo';
            document.getElementById('nodeText').value = node.text;
            document.getElementById('nodeType').value = node.type;
            document.getElementById('nodeX').value = node.x;
            document.getElementById('nodeY').value = node.y;
            document.getElementById('nodeModal').style.display = 'block';
        }

        function saveNode() {
            const text = document.getElementById('nodeText').value.trim();
            const type = document.getElementById('nodeType').value;
            const x = parseInt(document.getElementById('nodeX').value);
            const y = parseInt(document.getElementById('nodeY').value);

            if (!text) {
                alert('Inserisci un testo per il nodo');
                return;
            }

            if (selectedNode) {
                // Modifica nodo esistente
                selectedNode.text = text;
                selectedNode.type = type;
                selectedNode.x = x;
                selectedNode.y = y;
            } else {
                // Aggiungi nuovo nodo
                const newNode = {
                    id: nextNodeId++,
                    text: text,
                    type: type,
                    x: x,
                    y: y
                };
                nodes.push(newNode);
            }

            closeModal();
            render();
        }

        function addArrow() {
            const fromSelect = document.getElementById('arrowFrom');
            const toSelect = document.getElementById('arrowTo');
            
            fromSelect.innerHTML = '';
            toSelect.innerHTML = '';
            
            nodes.forEach(node => {
                const fromOption = document.createElement('option');
                fromOption.value = node.id;
                fromOption.textContent = node.text;
                fromSelect.appendChild(fromOption);
                
                const toOption = document.createElement('option');
                toOption.value = node.id;
                toOption.textContent = node.text;
                toSelect.appendChild(toOption);
            });

            document.getElementById('arrowLabel').value = '';
            document.getElementById('arrowModal').style.display = 'block';
        }

        function saveArrow() {
            const from = parseInt(document.getElementById('arrowFrom').value);
            const to = parseInt(document.getElementById('arrowTo').value);
            const label = document.getElementById('arrowLabel').value.trim();

            if (from === to) {
                alert('Non puoi creare una freccia da un nodo a se stesso');
                return;
            }

            const newArrow = { from, to, label };
            arrows.push(newArrow);

            closeModal();
            render();
        }

        function deleteSelected() {
            if (!selectedNode) {
                alert('Seleziona prima un nodo da eliminare');
                return;
            }

            if (confirm(`Sei sicuro di voler eliminare il nodo "${selectedNode.text}"?`)) {
                // Rimuovi nodo
                nodes = nodes.filter(n => n.id !== selectedNode.id);
                
                // Rimuovi frecce collegate
                arrows = arrows.filter(a => a.from !== selectedNode.id && a.to !== selectedNode.id);
                
                selectedNode = null;
                render();
            }
        }

        function closeModal() {
            document.getElementById('nodeModal').style.display = 'none';
            document.getElementById('arrowModal').style.display = 'none';
            document.getElementById('descriptionModal').style.display = 'none';
        }

        function saveDiagram() {
            const data = { nodes, arrows };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagramma_arte_romana.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadDiagram() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            nodes = data.nodes || [];
                            arrows = data.arrows || [];
                            nextNodeId = Math.max(...nodes.map(n => n.id), 0) + 1;
                            selectedNode = null;
                            render();
                        } catch (error) {
                            alert('Errore nel caricamento del file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function resetDiagram() {
            if (confirm('Sei sicuro di voler resettare il diagramma? Questo canceller√† tutte le modifiche.')) {
                nodes = [...initialData.nodes];
                arrows = [...initialData.arrows];
                nextNodeId = Math.max(...nodes.map(n => n.id)) + 1;
                selectedNode = null;
                render();
            }
        }

        // Funzioni per modificare le descrizioni
        function editDescriptions() {
            const select = document.getElementById('descriptionNodeSelect');
            select.innerHTML = '';
            
            nodes.forEach(node => {
                const option = document.createElement('option');
                option.value = node.id;
                option.textContent = `${node.text} (ID: ${node.id})`;
                select.appendChild(option);
            });

            // Se c'√® un nodo selezionato, selezionalo nel dropdown
            if (selectedNode) {
                select.value = selectedNode.id;
                loadNodeDescription(selectedNode.id);
            } else {
                // Altrimenti carica la descrizione del primo nodo
                if (nodes.length > 0) {
                    select.value = nodes[0].id;
                    loadNodeDescription(nodes[0].id);
                }
            }

            document.getElementById('descriptionModal').style.display = 'block';
        }

        function loadNodeDescription(nodeId) {
            const info = nodeInfo[nodeId];
            if (info) {
                document.getElementById('descriptionTitle').value = info.title || '';
                document.getElementById('descriptionText').value = info.description || '';
                document.getElementById('descriptionPeriod').value = info.period || '';
                document.getElementById('descriptionFeatures').value = info.features || '';
                document.getElementById('descriptionFunction').value = info.function || '';
                document.getElementById('descriptionPurpose').value = info.purpose || '';
                document.getElementById('descriptionType').value = info.type || '';
                document.getElementById('descriptionTechnique').value = info.technique || '';
                document.getElementById('descriptionMedium').value = info.medium || '';
                document.getElementById('descriptionLocation').value = info.location || '';
                document.getElementById('descriptionMaterial').value = info.material || '';
                document.getElementById('descriptionExample').value = info.example || '';
            } else {
                // Pulisci tutti i campi se non ci sono informazioni
                document.getElementById('descriptionTitle').value = '';
                document.getElementById('descriptionText').value = '';
                document.getElementById('descriptionPeriod').value = '';
                document.getElementById('descriptionFeatures').value = '';
                document.getElementById('descriptionFunction').value = '';
                document.getElementById('descriptionPurpose').value = '';
                document.getElementById('descriptionType').value = '';
                document.getElementById('descriptionTechnique').value = '';
                document.getElementById('descriptionMedium').value = '';
                document.getElementById('descriptionLocation').value = '';
                document.getElementById('descriptionMaterial').value = '';
                document.getElementById('descriptionExample').value = '';
            }
        }

        function saveDescription() {
            const nodeId = parseInt(document.getElementById('descriptionNodeSelect').value);
            const title = document.getElementById('descriptionTitle').value.trim();
            const description = document.getElementById('descriptionText').value.trim();
            const period = document.getElementById('descriptionPeriod').value.trim();
            const features = document.getElementById('descriptionFeatures').value.trim();
            const function_ = document.getElementById('descriptionFunction').value.trim();
            const purpose = document.getElementById('descriptionPurpose').value.trim();
            const type = document.getElementById('descriptionType').value.trim();
            const technique = document.getElementById('descriptionTechnique').value.trim();
            const medium = document.getElementById('descriptionMedium').value.trim();
            const location = document.getElementById('descriptionLocation').value.trim();
            const material = document.getElementById('descriptionMaterial').value.trim();
            const example = document.getElementById('descriptionExample').value.trim();

            if (!title || !description) {
                alert('Il titolo e la descrizione principale sono obbligatori');
                return;
            }

            // Crea o aggiorna l'oggetto delle informazioni del nodo
            const nodeInfoObj = {
                title: title,
                description: description
            };

            // Aggiungi campi opzionali solo se non vuoti
            if (period) nodeInfoObj.period = period;
            if (features) nodeInfoObj.features = features;
            if (function_) nodeInfoObj.function = function_;
            if (purpose) nodeInfoObj.purpose = purpose;
            if (type) nodeInfoObj.type = type;
            if (technique) nodeInfoObj.technique = technique;
            if (medium) nodeInfoObj.medium = medium;
            if (location) nodeInfoObj.location = location;
            if (material) nodeInfoObj.material = material;
            if (example) nodeInfoObj.example = example;

            // Aggiorna nodeInfo
            nodeInfo[nodeId] = nodeInfoObj;

            // Salva nel localStorage
            localStorage.setItem('nodeInfo', JSON.stringify(nodeInfo));

            alert('Descrizione salvata con successo!');
            closeModal();
        }

        // Event listener per cambiare nodo nel modal delle descrizioni
        document.addEventListener('DOMContentLoaded', function() {
            const descriptionNodeSelect = document.getElementById('descriptionNodeSelect');
            if (descriptionNodeSelect) {
                descriptionNodeSelect.addEventListener('change', function() {
                    const nodeId = parseInt(this.value);
                    loadNodeDescription(nodeId);
                });
            }
        });

        // Funzioni per esportare e importare descrizioni
        function exportDescriptions() {
            const data = JSON.stringify(nodeInfo, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'descrizioni_arte_romana.json';
            a.click();
            URL.revokeObjectURL(url);
            alert('Descrizioni esportate con successo!');
        }

        function importDescriptions() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedNodeInfo = JSON.parse(e.target.result);
                            
                            // Unisci le descrizioni importate con quelle esistenti
                            Object.assign(nodeInfo, importedNodeInfo);
                            
                            // Salva nel localStorage
                            localStorage.setItem('nodeInfo', JSON.stringify(nodeInfo));
                            
                            alert('Descrizioni importate con successo!');
                            console.log('Descrizioni importate:', importedNodeInfo);
                        } catch (error) {
                            alert('Errore nell\'importazione del file');
                            console.error('Errore importazione:', error);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

                 // Funzioni per il popup informativo
         function showInfoPopupById(nodeId) {
             console.log('showInfoPopupById chiamata con ID:', nodeId);
             console.log('Tipo di nodeId:', typeof nodeId);
             console.log('Nodi disponibili:', nodes.map(n => n.id));
             
             const parsedId = parseInt(nodeId);
             console.log('ID parsato:', parsedId);
             
             const node = nodes.find(n => n.id === parsedId);
             if (node) {
                 console.log('Nodo trovato:', node);
                 showInfoPopup(node);
             } else {
                 console.log('Nodo non trovato per ID:', nodeId);
                 console.log('Tentativo di trovare nodo con ID non parsato:', nodeId);
                 const nodeAlt = nodes.find(n => n.id == nodeId);
                 if (nodeAlt) {
                     console.log('Nodo trovato con confronto non stretto:', nodeAlt);
                     showInfoPopup(nodeAlt);
                 } else {
                     console.log('Nodo non trovato neanche con confronto non stretto');
                 }
             }
         }

         function showInfoPopup(node) {
             console.log('showInfoPopup chiamata per nodo:', node.id, node.text);
             const info = nodeInfo[node.id];
             if (!info) {
                 console.log('Nessuna informazione disponibile per il nodo:', node.id);
                 alert('Nessuna informazione disponibile per questo elemento');
                 return;
             }

            console.log('Informazioni trovate:', info);

            const popup = document.getElementById('infoPopup');
            const title = document.getElementById('popupTitle');
            const content = document.getElementById('popupContent');

            if (!popup || !title || !content) {
                console.error('Elementi popup non trovati');
                console.error('popup:', popup);
                console.error('title:', title);
                console.error('content:', content);
                return;
            }

            title.textContent = info.title;

            let contentHTML = `<p><strong>${info.description}</strong></p>`;
            
            // Aggiungi informazioni specifiche se disponibili
            if (info.period) contentHTML += `<p><strong>Periodo:</strong> ${info.period}</p>`;
            if (info.features) contentHTML += `<p><strong>Caratteristiche:</strong> ${info.features}</p>`;
            if (info.capacity) contentHTML += `<p><strong>Capacit√†:</strong> ${info.capacity}</p>`;
            if (info.feature) contentHTML += `<p><strong>Caratteristica:</strong> ${info.feature}</p>`;
            if (info.function) contentHTML += `<p><strong>Funzione:</strong> ${info.function}</p>`;
            if (info.purpose) contentHTML += `<p><strong>Scopo:</strong> ${info.purpose}</p>`;
            if (info.type) contentHTML += `<p><strong>Tipo:</strong> ${info.type}</p>`;
            if (info.technique) contentHTML += `<p><strong>Tecnica:</strong> ${info.technique}</p>`;
            if (info.medium) contentHTML += `<p><strong>Supporto:</strong> ${info.medium}</p>`;
            if (info.location) contentHTML += `<p><strong>Ubicazione:</strong> ${info.location}</p>`;
            if (info.material) contentHTML += `<p><strong>Materiale:</strong> ${info.material}</p>`;
            if (info.types) contentHTML += `<p><strong>Tipi:</strong> ${info.types}</p>`;
            if (info.example) contentHTML += `<p><strong>Esempio:</strong> ${info.example}</p>`;
            if (info.orders) contentHTML += `<p><strong>Ordini:</strong> ${info.orders}</p>`;

            content.innerHTML = contentHTML;

            // Posiziona il popup al centro dello schermo
            popup.style.display = 'block';
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            popup.style.zIndex = '3000';
            
            console.log('Popup mostrato per:', info.title);
            console.log('Contenuto HTML:', contentHTML);
        }

        function closeInfoPopup() {
            document.getElementById('infoPopup').style.display = 'none';
        }

        // Chiudi popup cliccando fuori
        document.addEventListener('click', function(e) {
            const popup = document.getElementById('infoPopup');
            if (popup && popup.style.display === 'block' && e.target === popup) {
                closeInfoPopup();
            }
        });

        // Funzione per mostrare/nascondere le frecce
        function toggleArrows() {
            arrowsVisible = !arrowsVisible;
            const btn = document.getElementById('toggleArrowsBtn');
            
            if (arrowsVisible) {
                btn.textContent = 'üëÅÔ∏è Nascondi Frecce';
                btn.className = 'btn btn-info';
            } else {
                btn.textContent = 'üëÅÔ∏è Mostra Frecce';
                btn.className = 'btn btn-info';
            }
            
            console.log('Frecce visibili:', arrowsVisible);
            render();
        }

                         // Inizializza il diagramma
        init();

        // Carica le descrizioni salvate dal localStorage
        const savedNodeInfo = localStorage.getItem('nodeInfo');
        if (savedNodeInfo) {
            try {
                const loadedNodeInfo = JSON.parse(savedNodeInfo);
                // Unisci le descrizioni caricate con quelle predefinite
                Object.assign(nodeInfo, loadedNodeInfo);
                console.log('Descrizioni caricate dal localStorage');
            } catch (error) {
                console.error('Errore nel caricamento delle descrizioni:', error);
            }
        }

        // Rendi le funzioni disponibili globalmente
        window.showInfoPopupById = showInfoPopupById;
        window.showInfoPopup = showInfoPopup;
        window.closeInfoPopup = closeInfoPopup;
         
         // Test delle funzioni globali
         console.log('Funzioni globali esposte:');
         console.log('window.showInfoPopupById:', typeof window.showInfoPopupById);
         console.log('window.showInfoPopup:', typeof window.showInfoPopup);
         console.log('window.closeInfoPopup:', typeof window.closeInfoPopup);
    </script>
</body>
</html> 